<!-- Ruby declarations here -->
<% @user = User.find(current_user.id) %>

<!-- Role module declarations -->
<% @okr_user_role = OkrUserRole.where(user_id: current_user.id) %>
<% @role = OkrRole.where(id: @okr_user_role[0].okr_role_id) %>

<!-- Personal OKR module declarations -->
<% @personal_objective = PersonalObjective.where(user_id: current_user.id) %>

<!-- Calculation of the overall progress -->
<% @completed_objective = 0 %>
<% if(@personal_objective.count != 0) %>
  <% @progress_portion = 100 / @personal_objective.count %>
  <% @total_progress = 0 %>
  <% @temp_date = [] %>
  <% @personal_objective.each do |item| %>
    <% @temp_progress = (item.progress/100) * @progress_portion %>
    <% @total_progress = @total_progress + @temp_progress %>
    <% # To check whether there is any completed objective %>  
    <% if(item.progress == 100.00) %>
      <% @completed_objective = @completed_objective + 1 %>
    <% end %>
    <% # To check which is the latest updated date %>
    <% @temp_date << item.updated_at %>
  <% end %>
  <% @date_max = @temp_date.max %>
  <% @date_difference = (Time.now - @date_max) / 86400 %>
<% end %>

<!-- START JUMBOTRON -->
<div class="jumbotron" data-pages="parallax">
  <div class="container-fluid container-fixed-lg sm-p-l-20 sm-p-r-20">
    <div class="inner">
      <!-- START BREADCRUMB -->
      <ul class="breadcrumb">
        <li>
          <p>HOME</p>
        </li>
        <li>
          <a href="/" class="active">MY PERSONAL OKRs</a>
        </li>
      </ul>
      <!-- END BREADCRUMB -->
    </div>
  </div>
</div>
<!-- END JUMBOTRON -->
<!-- START CONTAINER FLUID -->
<div class="container-fluid container-fixed-lg">

  <!-- BEGIN PlACE PAGE CONTENT HERE -->
  <h5 class="semi-bold">My personal OKRs</h5>

  <div class="row">
    <!-- User related information and percentage of OKR aligned -->
    <div class="col-lg-5 col-md-5 col-sm-5 padding-body">
      <div class="col-lg-5 col-md-5 col-sm-5 padding-body">
        <%= image_tag @user.avatar.url %>
      </div>
      <div class="col-lg-7 col-md-7 col-sm-7" >
        <div class="row">
          <%= content_tag(:div, content_tag(:h5, @user.name, class: "bold")) %>
        </div>
        <div class="row">
          <div class="form-group">
            <label>ROLE</label>
            <%= content_tag(:div, content_tag(:p, @role[0].name, class: "bold" )) %>
          </div>
        </div>
        <div class="row">
          <div class="form-group">
            <label class="small">TEAMS</label>
            <div>
              <%  @user.okr_teams.each_with_index do |team,index|  %>  
                <% if index == @user.okr_teams.size - 1 %>
                  <%= content_tag(:span, team.name, class: "bold" ) %>
                <% else %>
                  <%= content_tag(:span, team.name + ",", class: "bold" ) %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- All the progress bars -->
    <div class="col-lg-7 col-md-7 col-sm-7">
      <div class="col-md-3 col-sm-3 padding-body">
        <div class="c100 p100">
          <span>
            <span id="okr_aligned_percentage">100%</span> <br/>
            <p>aligned</p>
          </span>
          <div class="slice">
            <div class="bar"></div>
            <div class="fill"></div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-3 padding-body">
        <div class="c100 p<%= @completed_objective %>">
          <span>
            <span id="completed_objective_portion">
              <%= @completed_objective %>/<%= @personal_objective.count %>
            </span> <br/>
            <p>objectives</p>
          </span>
          <div class="slice">
            <div class="bar"></div>
            <div class="fill"></div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-3 padding-body">
        <div class="c100 p<%= @total_progress.to_i %>">
          <span>
            <span id="overall_okr_progress">
              <%= @total_progress.to_i %>%
            </span> <br/>
            <p>overall progress</p>
          </span>
          <div class="slice">
            <div class="bar"></div>
            <div class="fill"></div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-3 padding-body">
        <div class="c100 p<%= @date_difference.to_i %>">
          <span>
            <span id="last_updated">
              <% if(@personal_objective.count == 0) %>
              <%= '-' %>
              <% else %>
                <%= @date_difference.to_i %>
              <% end %>
            </span>  
            <p>days ago</p> 
          </span>
          <div class="slice">
            <div class="bar"></div>
            <div class="fill"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accordion involved all the OKR progresses -->
  <div class="row padding-accordion-group">
    <% @personal_objective.each_with_index do |item,index| %>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab">
          <h4 class="panel-title panel-title-custom">
            <div class="row">
              <div class="col-lg-11 col-md-11 col-sm-11">
                <a class="collapsed panel-heading-a" data-toggle="collapse" data-parent="#accordion" href="#personal_obj_<%= index %>" aria-expanded="false" aria-controls="personal_obj_<%= index %>">
                  <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                      <% @okr_team_personal = OkrTeamPersonal.where(personal_objective_id: item.id) %>
                      <% @team_key_result = TeamKeyResult.where(id: @okr_team_personal[0].team_key_result_id) %>
                      <div>
                        <%= content_tag(:p, @team_key_result[0].key_result, class: "small" ) %>
                        <%= content_tag(:span, item.objective, class: "bold" ) %>
                      </div>
                    </div>
                    <div class="col-lg-1 col-md-1 col-sm-1">
                      <div class="text-center">
                        <p class="small">Contribution</p>
                        <div class="text-center">
                          <span class="bold">21%</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-2">
                      <div class="text-center">
                        <p class="small">Days left</p>
                        <div class="text-center">
                          <span class="bold">55</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3" style="padding-left:0px;">
                      <%= content_tag(:div, content_tag(:span, item.progress.to_s + "%", class: "bold" ), class: "text-center") %>
                      <br />
                      <div class="progress">
                        <div class="progress-bar progress-bar-primary" style="width:<%= item.progress %>%"></div>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-lg-1 col-md-1 col-sm-1">
                <div class="pull-right">
           	      <button class="btn btn-accordion">
           	        <i class="pg-menu"></i>
           	      </button>
           	    </div>
              </div>
            </div>
          </h4>
        </div>
        <div id="personal_obj_<%= index %>" class="panel-collapse collapse" role="tabpanel" aria-labelledby="personal_obj_<%= index %> ">
          <div class="panel-body no-padding">
            <!-- Find out the key result linked to the objective -->
            <% @personal_key_result = PersonalKeyResult.where(personal_objective_id: item.id) %>
            <% @personal_key_result_count = @personal_key_result.count %>
            <% @personal_key_result_completed = 0 %>
            <% @personal_key_result.each_with_index do |item,index| %>
              <% if(item.progress == 100.00) %>
              <%    @personal_key_result_completed = @personal_key_result_completed + 1 %>
              <% end %>
              <div id="personal_key_result_<%= item.id %>" class="row accordion-item">
                <div class="col-lg-11 col-md-11 col-sm-11">
                  <div class="row checkbox">
                    <div class="col-lg-6 col-md-6 col-sm-6 item-content">
                      <div class="accordion-item-title">
                        <div class="checkbox-primary">
                          <input type="checkbox" value="<%= item.id %>" id="personal_kr_<%= item.id %>"/>
                          <label for="personal_kr_<%= item.id %>"><%= item.key_result %></label>
                        </div> 
                      </div>
                    </div>
                    <div class="col-lg-1 col-md-1 col-sm-1">
                      <div class="text-center">
                        <span class="bold">21%</span>
                      </div>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-2">
                      <div class="text-center">
                        <span class="bold">5</span>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3 no-padding">
                      <%= content_tag(:div, content_tag(:span, item.progress.to_s + "%", class: "bold", id: "personal_kr_progress_" + item.id.to_s ), class: "text-center small") %>
                      <div class="progress">
                        <div class="progress-bar progress-bar-primary" style="width:<%= item.progress %>%"></div>
                      </div>    
                    </div>
                  </div>
                </div>
                <div class="col-lg-1 col-md-1 col-sm-1">
                  <div class="dropdown pull-right">
           	        <button class="btn btn-accordion" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
           	          <i class="pg-menu"></i>
           	        </button>
                    <ul class="dropdown-menu">
                      <li>
                        <!-- JS : Contribution page -->
                        <a href="/" data-toggle="search" id="keyresultprogress_<%= item.id %>">
                          <i class="fa fa-fw fa-plus"></i> 
                           Progress update
                        </a>
                      </li>
                    </ul>
                    <!-- <a href="#" class="search-link" data-toggle="contribution"> -->
           	      </div>
                </div>
              </div>
            <% end %>

            <!-- New row for the add in of new key results over here -->
            <div class="row accordion-item add-row">
              <div class="panel-heading" role="tab">
              </div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <div class="row">
            <div class="col-md-4 col-sm-4 bold small">
              <%= @personal_key_result_count %> Key Results
            </div>
            <div class="col-md-4 col-sm-4">
              <div class="text-center">
                <span class="caret"></span>
              </div>
            </div>
            <div class="col-md-4 col-sm-4">
              <div class="pull-right bold small">
                <%= @personal_key_result_completed %> Completed
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          Add new objective
        </h4>
      </div>
    </div>
  </div>

  <!-- END PLACE PAGE CONTENT HERE -->

</div>
<!-- END CONTAINER FLUID -->

<!-- Popup for the contribution module -->
<div class="overlay hide" data-pages="search" id="contribution_popup">
  <div class="overlay-content has-results m-t-20">
    <div class="container-fluid">
      <a href="/" class="close-icon-light overlay-close text-black fs-16">
        <i class="pg-close"></i>
      </a>
    </div>
    <div class="centralize">
      <div class="container-fluid">
        <div class="col-lg-3 col-md-3 col-sm-3">
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
          <h5 class="m-b-5">
            <span class="semi-bold result-name">
            	Confirm progress update for: <br/>
              <span class="bold" id="personal_key_result">xxxxxx</span>
            </span>
          </h5>
        </div>
        <div class="row">
          <div class="no-padding m-t-50">
            <div class="bg-master" id="slider-tooltips">
            </div>
          </div>
        </div>
        <br/>
        <br/>
        <div class="row">
          <form role="form">
            <div class="row">           
                <div class="form-group form-group-default">
                  <label>WHAT DID YOU CONTRIBUTE TO THIS OKR?</label>
                  <textarea class="form-control textarea-custom" required></textarea>
                </div>
            </div>
            <div class="row">
                <div class="pull-left">
                  <div class="checkbox checkbox-success">
                    <input type="checkbox" id="checkbox_kr_done" value="complete_kr"/>
                    <label for="checkbox_kr_done">Mark KR as completed</label>
                  </div>
                </div>
                <div class="pull-right">
                  <a href="/" class="btn btn-default btn-cons btn-rounded m-t-10">
                    Cancel
                  </a>
                  <button class="btn btn-complete btn-cons btn-rounded m-t-10" disabled="true">
                    Save
                  </button>
                </div>
            </div>
          </form>
        </div>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-3">
        </div>
      </div>
    </div>
  </div>
</div>

